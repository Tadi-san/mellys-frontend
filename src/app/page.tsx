"use client";

import { Suspense, useEffect, useState } from "react";
import ItemCard from "@/components/ItemCard";
import { api } from "@/utils/index.api";
import Link from "next/link";
import Cookies from "js-cookie";
import SimpleAdsCarousel from "@/components/SimpleAdsCarousel";

// Skeleton Loader for Categories
const CategorySkeleton = () => (
  <div className="flex flex-col gap-2 justify-start items-center animate-pulse">
    <div className="w-12 h-12 bg-gray-300 rounded-full" />
    <div className="w-20 h-4 bg-gray-300 rounded" />
  </div>
);

// Skeleton Loader for Products
const ProductSkeleton = () => (
  <div className="flex flex-col gap-2 md:gap-0 group hover:border hover:shadow-lg relative w-[180px] md:w-[250px] h-[260px] md:h-[350px] overflow-hidden group rounded-lg animate-pulse">
    <div className="relative w-full h-full bg-gray-300" />
    <div className="w-24 h-4 bg-gray-300 rounded mt-4 mb-1 mx-2" />
    <div className="w-16 h-6 bg-gray-300 rounded mt-2 mx-2" />
  </div>
);

export default function Home() {
  const [products, setProducts] = useState<any>([]);
  const [categories, setCategories] = useState<any>([]);
  const [loadingCategories, setLoadingCategories] = useState(true);
  const [loadingProducts, setLoadingProducts] = useState(true);

  // Fetch categories and products
  useEffect(() => {
    const fetchData = async () => {
      try {
        const [categoriesResponse, productsResponse] = await Promise.all([
          api.getCategories(),
          api.getProducts(),
        ]);

        // Filter and map categories
        const refinedCategories = categoriesResponse
          .filter((category: any) => category.parentId === null)
          .map((category: any) => ({
            id: category.id,
            name: category.name,
            img: category.images.length > 0 ? category.images[0].image_url : "",
          }))
          .slice(0, 8);
        setCategories(refinedCategories);

        // Set products
        setProducts(productsResponse);
      } catch (error) {
        console.error("Error fetching data:", error);
      } finally {
        setLoadingCategories(false);
        setLoadingProducts(false);
      }
    };

    fetchData();
  }, []);

  return (
    <main className="flex flex-col items-center">
      <div className="relative w-full max-w-screen-2xl">
        <div className="flex gap-2 justify-around mb-5">
          {loadingCategories
            ? Array(8)
                .fill(0)
                .map((_, index) => <CategorySkeleton key={index} />)
            : categories.map((item: any) => (
                <Link
                  href={`/search/${item.name}`}
                  key={item.id}
                  className="flex flex-col gap-1 justify-start items-center"
                >
                  <img
                    src={item.img}
                    alt="img"
                    className="w-12 h-12 object-contain rounded-full"
                  />
                  <div className="text-xs text-start">{item.name}</div>
                </Link>
              ))}
        </div>
        
        {/* Ads Carousel */}
        <div className="mb-8 px-4">
          <SimpleAdsCarousel 
            autoPlayInterval={4000}
            height="100px"
            className="max-w-4xl mx-auto"
          />
        </div>

        <div className="flex flex-wrap gap-y-5 gap-x-2 md:gap-10 justify-center">
          {loadingProducts
            ? Array(8)
                .fill(0)
                .map((_, index) => <ProductSkeleton key={index} />)
            : products &&
              products.map((product: any, index: number) => (
                <div key={index}>
                  <ItemCard product={product} />
                </div>
              ))}
        </div>
      </div>
    </main>
  );
}

// app/maintenance/page.tsx (or pages/maintenance.tsx for older Next.js)
// export default function Home() {
//   return (
//     <main className="flex flex-col min-h-screen items-center justify-center bg-gradient-to-r from-indigo-500 to-purple-600 text-white p-6">
//       <div className="animate-bounce text-5xl mb-6">ðŸ”§</div>
//       <h1 className="text-4xl font-bold mb-2">Under Maintenance</h1>
//       <p className="text-xl opacity-90 mb-4">We&apos;re working hard behind the scenes.</p>
//       <p className="text-lg text-center max-w-xl mb-6">
//         Our site is temporarily offline while we improve your experience.
//         We&apos;ll be back soon with something great!
//       </p>
//       <p className="text-yellow-300 font-semibold text-lg animate-pulse">
//         ðŸš€ Launching soon with Telebirr! ðŸš€
//       </p>
//     </main>
//   );
// }

//  */
// const createSubscription = async (requestAnimationFrame, resizeBy, next) => {
//     try {
//           const errors = validationResult(req);
//               if (!errors.isEmpty()) {
//                       return resizeBy.status(400).json({ 
//                                 success: false, 
//                                         errors: errors.array() 
//                       });
//                     }

//                         const { planId } = requestAnimationFrame.body;
//                             const userId = requestAnimationFrame.user.id;
//                                 const userEmail = requestAnimationFrame.user.email;

//                                     // Validate plan exists and is subscription
//                                         const planConfig = paddleConfig.getProductConfig()[planId];
//                                             if (!planConfig) {
//                                                     return resizeBy.status(400).json({
//                                                               success: false,
//                                                                       message: 'Invalid plan ID'
//                                                     });
//                                                   }

//                                                       if (planConfig.type !== 'subscription') {
//                                                               return resizeBy.status(400).json({
//                                                                         success: false,
//                                                                                 message: 'This endpoint is for subscriptions only. Use /checkout for one-time purchases.'
//                                                               });
//                                                             }

//                                                                 // Check if user already has an active subscription
//                                                                     const existingSubscription = await prisma.subscription.findFirst({
//                                                                             where: {
//                                                                                       user_id: userId,
//                                                                                               status: {
//                                                                                                           in: ['active', 'trialing', 'past_due']
//                                                                                               }
//                                                                                             }
//                                                                                           });

//                                                                                               if (existingSubscription) {
//                                                                                                       return resizeBy.status(400).json({
//                                                                                                                 success: false,
//                                                                                                                         message: 'You already have an active subscription. Please cancel it first to change plans.'
//                                                                                                       });
//                                                                                                     }

//                                                                                                         // Create subscription checkout with Paddle
//                                                                                                             const checkoutSession = await paddleConfig.createSubscriptionCheckout(
//                                                                                                                     planId,
//                                                                                                                           userId,
//                                                                                                                                 userEmail,
//                                                                                                                                       { credits: planConfig.credits, plan_name: planConfig.name }
//                                                                                                             );

//                                                                                                                 resizeBy.json({
//                                                                                                                         success: true,
//                                                                                                                               checkout_url: checkoutSession.checkout_url,
//                                                                                                                                     plan: {
//                                                                                                                                               name: planConfig.name,
//                                                                                                                                                       credits: planConfig.credits,
//                                                                                                                                                               type: planConfig.type,
//                                                                                                                                                                       period: <planConfig className="period">      }
//                                                                                                                                                                           });
                                                                                                                                                                          
//                                                                                                                                                                             } catch (error) {
//                                                                                                                                                                                   console.error('Subscription creation error:', error);
//                                                                                                                                                                                       res.status(500).json({
//                                                                                                                                                                                               success: false,
//                                                                                                                                                                                                     message: 'Failed to create subscription checkout',
//                                                                                                                                                                                                           error: process.env.NODE_ENV === 'development' ? error.message : 'Internal server error'
//                                                                                                                                                                                       });
//                                                                                                                                                                                     }
//                                                                                                                                                                                     };

//                                                                                                                                                                                     /**
//                                                                                                                                                                                      * Handle Paddle webhooks
//                                                                                                                                                                                       * @route POST /api/payments/paddle/webhooks */
//                                                                                                                                                                                       const handlePaddleWebhook = async (req, res, next) => {
//                                                                                                                                                                                           try {
//                                                                                                                                                                                                 const signature = req.get('X-Paddle-Signature') || req.body.p_signature;
//                                                                                                                                                                                                     const rawBody = JSON.stringify(req.body);

//                                                                                                                                                                                                         // Verify webhook signature
//                                                                                                                                                                                                             if (!paddleConfig.verifyWebhookSignature(rawBody, signature)) {
//                                                                                                                                                                                                                     console.error('Invalid webhook signature');
//                                                                                                                                                                                                                           return res.status(401).json({
//                                                                                                                                                                                                                                     success: false,
//                                                                                                                                                                                                                                             message: 'Invalid webhook signature'
//                                                                                                                                                                                                                           });
//                                                                                                                                                                                                                         }

//                                                                                                                                                                                                                             const eventType = req.body.alert_name;
//                                                                                                                                                                                                                                 const eventData = req.body;

//                                                                                                                                                                                                                                     console.log(`Processing Paddle webhook: ${eventType}`);

//                                                                                                                                                                                                                                         switch (eventType) {
//                                                                                                                                                                                                                                                 case 'payment_succeeded':
//                                                                                                                                                                                                                                                           await handlePaymentSucceeded(eventData);
//                                                                                                                                                                                                                                                                   break;
                                                                                                                                                                                                                                                                        
//                                                                                                                                                                                                                                                                         case 'subscription_created':
//                                                                                                                                                                                                                                                                                   await handleSubscriptionCreated(eventData);
//                                                                                                                                                                                                                                                                                           break;
                                                                                                                                                                                                                                                                                                
//                                                                                                                                                                                                                                                                                                 case 'subscription_payment_succeeded':
//                                                                                                                                                                                                                                                                                                           await handleSubscriptionPaymentSucceeded(eventData);
//                                                                                                                                                                                                                                                                                                                   break;
                                                                                                                                                                                                                                                                                                                        
//                                                                                                                                                                                                                                                                                                                         case 'subscription_cancelled':
//                                                                                                                                                                                                                                                                                                                                   await handleSubscriptionCancelled(eventData);
//                                                                                                                                                                                                                                                                                                                                           break;
                                                                                                                                                                                                                                                                                                                                                
//                                                                                                                                                                                                                                                                                                                                                 case 'subscription_payment_failed':
//                                                                                                                                                                                                                                                                                                                                                           await handleSubscriptionPaymentFailed(eventData);
//                                                                                                                                                                                                                                                                                                                                                                   break;
                                                                                                                                                                                                                                                                                                                                                                        
//                                                                                                                                                                                                                                                                                                                                                                         default:
//                                                                                                                                                                                                                                                                                                                                                                                   console.log(`Unhandled webhook event: ${eventType}`);
//                                                                                                                                                                                                                                         }

//                                                                                                                                                                                                                                             res.json({ success: true });

//                                                                                                                                                                                                                                       } catch (error) {
//                                                                                                                                                                                                                                             console.error('Webhook processing error:', error);
//                                                                                                                                                                                                                                                 res.status(500).json({
//                                                                                                                                                                                                                                                         success: false,
//                                                                                                                                                                                                                                                               message: 'Webhook processing failed'
//                                                                                                                                                                                                                                                 });
//                                                                                                                                                                                                                                               }
//                                                                                                                                                                                                                                               };

//                                                                                                                                                                                                                                               /**
//                                                                                                                                                                                                                                                * Handle successful one-time payment_succeeded */
//                                                                                                                                                                                                                                                const handlePaymentSucceeded = async (eventData) => {
//                                                                                                                                                                                                                                                   const { order_id, passthrough, product_id, sale_gross } = eventData;
                                                                                                                                                                                                                                                    
//                                                                                                                                                                                                                                                     try {
//                                                                                                                                                                                                                                                           const customData = JSON.parse(passthrough || '{}');
//                                                                                                                                                                                                                                                               const userId = customData.user_id;
                                                                                                                                                                                                                                                                  
//                                                                                                                                                                                                                                                                   if (!userId) {
//                                                                                                                                                                                                                                                                           throw new Error('No user ID in payment data');
//                                                                                                                                                                                                                                                                   }

//                                                                                                                                                                                                                                                                       // Check for duplicate processing
//                                                                                                                                                                                                                                                                           const existingPayment = await prisma.paymentLog.findUnique({
//                                                                                                                                                                                                                                                                                   where: { paddle_order_id: order_id }
//                                                                                                                                                                                                                                                                           });

//                                                                                                                                                                                                                                                                               if (existingPayment) {
//                                                                                                                                                                                                                                                                                       console.log(`Payment ${order_id} already processed`);
//                                                                                                                                                                                                                                                                                             return;
//                                                                                                                                                                                                                                                                               }

//                                                                                                                                                                                                                                                                                   // Get product configuration
//                                                                                                                                                                                                                                                                                       const productConfig = paddleConfig.getProductConfig()[product_id];
//                                                                                                                                                                                                                                                                                           if (!productConfig) {
//                                                                                                                                                                                                                                                                                                   throw new Error(`Unknown product ID: ${product_id}`);
//                                                                                                                                                                                                                                                                                           }

//                                                                                                                                                                                                                                                                                               // Add credits to user and log payment
//                                                                                                                                                                                                                                                                                                   await prisma.$transaction([
//                                                                                                                                                                                                                                                                                                           prisma.user.update({
//                                                                                                                                                                                                                                                                                                                     where: { id: userId },
//                                                                                                                                                                                                                                                                                                                             data: {
//                                                                                                                                                                                                                                                                                                                                         credits: {
//                                                                                                                                                                                                                                                                                                                                                       increment: <productConfig className="credits">          }
//                                                                                                                                                                                                                                                                                                                                                               }
//                                                                                                                                                                                                                                                                                                                                                                     }),
//                                                                                                                                                                                                                                                                                                                                                                           prisma.paymentLog.create({
//                                                                                                                                                                                                                                                                                                                                                                                     data: {
//                                                                                                                                                                                                                                                                                                                                                                                                 user_id: userId,
//                                                                                                                                                                                                                                                                                                                                                                                                           paddle_order_id: order_id,
//                                                                                                                                                                                                                                                                                                                                                                                                                     product_id,
//                                                                                                                                                                                                                                                                                                                                                                                                                               amount: parseFloat(sale_gross),
//                                                                                                                                                                                                                                                                                                                                                                                                                                         credits_added: productConfig.credits,
//                                                                                                                                                                                                                                                                                                                                                                                                                                                   payment_type: 'one_time',
//                                                                                                                                                                                                                                                                                                                                                                                                                                                             status: 'completed'
//                                                                                                                                                                                                                                                                                                                                                                                     }
//                                                                                                                                                                                                                                                                                                                                                                                   })
//                                                                                                                                                                                                                                                                                                                                                                                       ]);

//                                                                                                                                                                                                                                                                                                                                                                                           console.log(`Added ${productConfig.credits} credits to user ${userId}`);
//                                                                                                                                                                                                                                                                                                                                                                                             } catch (error) {
//                                                                                                                                                                                                                                                                                                                                                                                                   console.error('Error processing payment succeeded:', error);
//                                                                                                                                                                                                                                                                                                                                                                                                       throw error;
//                                                                                                                                                                                                                                                                                                                                                                                             }
//                                                                                                                                                                                                                                                                                                                                                                                             };

//                                                                                                                                                                                                                                                                                                                                                                                             /**
//                                                                                                                                                                                                                                                                                                                                                                                              * Handle subscription creation */
//                                                                                                                                                                                                                                                                                                                                                                                              const handleSubscriptionCreated = async (eventData) => {
//                                                                                                                                                                                                                                                                                                                                                                                                 const { subscription_id, user_id, subscription_plan_id, status, passthrough } = eventData;
                                                                                                                                                                                                                                                                                                                                                                                                  
//                                                                                                                                                                                                                                                                                                                                                                                                   try {
//                                                                                                                                                                                                                                                                                                                                                                                                         const customData = JSON.parse(passthrough || '{}');
//                                                                                                                                                                                                                                                                                                                                                                                                             const userId = customData.user_id || user_id;
                                                                                                                                                                                                                                                                                                                                                                                                                
//                                                                                                                                                                                                                                                                                                                                                                                                                 if (!userId) {
//                                                                                                                                                                                                                                                                                                                                                                                                                         throw new Error('No user ID in subscription data');
//                                                                                                                                                                                                                                                                                                                                                                                                                 }

//                                                                                                                                                                                                                                                                                                                                                                                                                     // Get plan configuration
//                                                                                                                                                                                                                                                                                                                                                                                                                         const planConfig = paddleConfig.getProductConfig()[subscription_plan_id];
//                                                                                                                                                                                                                                                                                                                                                                                                                             if (!planConfig) {
//                                                                                                                                                                                                                                                                                                                                                                                                                                     throw new Error(`Unknown plan ID: ${subscription_plan_id}`);
//                                                                                                                                                                                                                                                                                                                                                                                                                             }

//                                                                                                                                                                                                                                                                                                                                                                                                                                 // Create subscription record
//                                                                                                                                                                                                                                                                                                                                                                                                                                     await prisma.subscription.create({
//                                                                                                                                                                                                                                                                                                                                                                                                                                             data: {
//                                                                                                                                                                                                                                                                                                                                                                                                                                                       user_id: userId,
//                                                                                                                                                                                                                                                                                                                                                                                                                                                               paddle_subscription_id: subscription_id,
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                       plan_id: subscription_plan_id,
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                               status: status.toLowerCase(),
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       credits_per_period: planConfig.credits,
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               current_period_start: new Date(),
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       current_period_end: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000) // 30 days
//                                                                                                                                                                                                                                                                                                                                                                                                                                             }
//                                                                                                                                                                                                                                                                                                                                                                                                                                           });

//                                                                                                                                                                                                                                                                                                                                                                                                                                               // Add initial credits
//                                                                                                                                                                                                                                                                                                                                                                                                                                                   await prisma.user.update({
//                                                                                                                                                                                                                                                                                                                                                                                                                                                           where: { id: userId },
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                 data: {
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                           credits: {
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       increment: <planConfig className="credits">        }
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             }
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     console.log(`Created subscription ${subscription_id} for user ${userId}`);
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       } catch (error) {
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             console.error('Error processing subscription created:', error);
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 throw error;
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       }
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       };

//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       /**
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        * Handle successful subscription payment (renewal)
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         */
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         const handleSubscriptionPaymentSucceeded = async (eventData) => {
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             const { subscription_id, sale_gross } = eventData;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               try {
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     // Find subscription
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         const subscription = await prisma.subscription.findUnique({
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 where: { paddle_subscription_id: subscription_id }
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         });

//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             if (!subscription) {
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     throw new Error(`Subscription not found: ${subscription_id}`);
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             }

//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 // Check for duplicate processing
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     const existingPayment = await prisma.paymentLog.findFirst({
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             where: {
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       paddle_subscription_id: subscription_id,
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               created_at: {
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           gte: new Date(Date.now() - 24 * 60 * 60 * 1000) // Last 24 hours
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               }
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             }
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           });

//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               if (existingPayment) {
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       console.log(`Subscription payment ${subscription_id} already processed recently`);
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             return;
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               }

//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   // Add credits and log payment
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       await prisma.$transaction([
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               prisma.user.update({
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         where: { id: subscription.user_id },
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 data: {
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             credits: {
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           increment: <subscription className="credits_per_period">          }
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   }
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         }),
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               prisma.subscription.update({
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         where: { id: subscription.id },
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 data: {
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             status: 'active',
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       current_period_start: new Date(),
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 current_period_end: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000)
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 }
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               }),
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     prisma.paymentLog.create({
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               data: {
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           user_id: subscription.user_id,
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     paddle_subscription_id: subscription_id,
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               product_id: subscription.plan_id,
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         amount: parseFloat(sale_gross),
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   credits_added: subscription.credits_per_period,
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             payment_type: 'subscription',
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       status: 'completed'
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               }
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             })
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 ]);

//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     console.log(`Renewed subscription ${subscription_id}, added ${SubscriptIcon.credits_per_period} credits`);
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       } catch (error) {
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             console.error('Error processing subscription payment:', error);
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 throw error;
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       }
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       };

//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       /**
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        * Handle subscription cancellation
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         */
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         const handleSubscriptionCancelled = async (eventData) => {
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             const { subscription_id } = eventData;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               try {
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     await prisma.subscription.update({
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             where: { paddle_subscription_id: subscription_id },
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   data: {
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             status: 'cancelled',
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     cancelled_at: new Date()
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   }
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 });

//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     console.log(`Cancelled subscription ${subscription_id}`);
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               } catch (error) {
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     console.error('Error processing subscription cancellation:', error);
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         throw error;
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               }
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             };

//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             /**
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              * Handle failed subscription payment */
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              const handleSubscriptionPaymentFailed = async (eventData) => {
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 const { subscription_id } = eventData;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   try {
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         await prisma.subscription.update({
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 where: { paddle_subscription_id: subscription_id },
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       data: {
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 status: 'past_due'
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       }
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     });

//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         console.log(`Subscription ${subscription_id} marked as past due`);
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   } catch (error) {
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         console.error('Error processing subscription payment failure:', error);
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             throw error;
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   }
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 };

//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 /**
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  * Get user's payment history
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   * @route GET /api/payments/history */
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   const getPaymentHistory = async (req, res, next) => {
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       try {
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             const userId = req.user.id;
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 const page = parseInt(req.query.page) || 1;
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     const limit = parseInt(req.query.limit) || 10;
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         const skip = (page - 1) * limit;

//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             const [payments, total] = await Promise.all([
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     prisma.paymentLog.findMany({
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               where: { user_id: userI},
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       orderBy: { created_at: 'desc' },
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               skip,
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       take: limit      }),
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             prisma.paymentLog.count({
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       where: { user_id: userId }
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             })
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ]);

//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               res.json({
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       success: true,
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             payments,
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   pagination: {
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             pageXOffset,
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     limit,
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             total,
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     pages: Math.ceil(total / limit)
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   }
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 });
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               } catch (error) {
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     next(error);
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               }
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               };

//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               /**
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * Get user's current subscription * @route GET /api/payments/subscription */
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                const getCurrentSubscription = async (req, res, next) => {
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   try {
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         const userId = req.user.id;

//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             const subscription = await pris
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   }
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }' */
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               }
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   }
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               })
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             })
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     })
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ])
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       }
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   }' */
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   }
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       }
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         })
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   }
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              } */
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               }
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   }
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     })
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               }
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         } */
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       }
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               }
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     })
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 }
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               })</subscription>
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             }
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 }
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               })
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       ])
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               }
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               }
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             }
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     })
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             }
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         })
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               }
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         } */
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       }</planConfig>
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                           }
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                 }
//                                                                                                                                                                                                                                                                                                                                                                                                                                                   })
//                                                                                                                                                                                                                                                                                                                                                                                                                                             }
//                                                                                                                                                                                                                                                                                                                                                                                                                                     })
//                                                                                                                                                                                                                                                                                                                                                                                                                             }
//                                                                                                                                                                                                                                                                                                                                                                                                                 }
//                                                                                                                                                                                                                                                                                                                                                                                                   }
//                                                                                                                                                                                                                                                                                                                                                                                              } */
//                                                                                                                                                                                                                                                                                                                                                                                             }
//                                                                                                                                                                                                                                                                                                                                                                                     }
//                                                                                                                                                                                                                                                                                                                                                                           })</productConfig>
//                                                                                                                                                                                                                                                                                                                                         }
//                                                                                                                                                                                                                                                                                                                             }
//                                                                                                                                                                                                                                                                                                           })
//                                                                                                                                                                                                                                                                                                   ])
//                                                                                                                                                                                                                                                                                           }
//                                                                                                                                                                                                                                                                               }
//                                                                                                                                                                                                                                                                           })
//                                                                                                                                                                                                                                                                   }
//                                                                                                                                                                                                                                                     }
//                                                                                                                                                                                                                                                } */
//                                                                                                                                                                                                                                                 })
//                                                                                                                                                                                                                                       }
//                                                                                                                                                                                                                                         }
//                                                                                                                                                                                                                           })
//                                                                                                                                                                                                             }
//                                                                                                                                                                                           }
//                                                                                                                                                                                       } */
//                                                                                                                                                                                       })
//                                                                                                                                                                             }</planConfig>
//                                                                                                                                     }
//                                                                                                                 })
//                                                                                                             )
//                                                                                                       })
//                                                                                               }
//                                                                                               }
//                                                                             }
//                                                                     })
//                                                               })
//                                                       }
//                                                     })
//                                             }
//                       })
//               }
//     }
// }